name: UX Dev Private Build and Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev-private-ssg'
jobs:
  build_publish_promote:
    runs-on:
      # Specify your runner group name. Use the runner group chosen when creating your Katana application
      labels: self-hosted
      group: 6429-etlbatchrunnerlh
    steps:
      - name: Validate that we are on a Graviton / arm64 runner
        uses: gdcorp-actions/validate-arm64@v1
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Obtain a JWT to authenticate all Katana-related actions with the katana-auth GitHub Action
      - id: katana-auth
        name: Authenticate with Katana
        uses: gdcorp-actions/katana-auth@v1

      # Retrieve Katana application info with the katana-get-app GitHub Action
      - id: katana-app
        name: Get Katana App Info
        uses: gdcorp-actions/katana-get-app@v1
        with:
          jwt: ${{ steps.katana-auth.outputs.jwt }}

      # Sets up authentication with Amazon ECR in the chosen region. Note that the URL can be obtained from GoDaddy's Golden Containers Registry at `https://gcr.katana.int.gdcorp.tools/`.
      - name: Golden Container Registry Login
        run: |
          aws ecr get-login-password --region us-west-2 | docker login 764525110978.dkr.ecr.us-west-2.amazonaws.com/alpine-node:latest.dkr.ecr.us-west-2.amazonaws.com -u AWS --password-stdin
      # Get the Artifactory token from ASM - assumes it has already been set up at artifactory_ro_creds. See https://github.com/gdcorp-actions/fetch-artifactory-creds
      - name: Fetch artifactory token
        uses: gdcorp-actions/fetch-artifactory-creds@v1
      - name: Set node up
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Execute the necessary commands to build your application's Docker container image. Place any further build commands under `run:`
      - name: Build Container
        run: |
          # builds the prod image first
          docker build --platform linux/arm64 --no-cache --force-rm --secret id=npm_token,env=ARTIFACTORY_RO_TOKEN \
            --build-arg GIT_SHORT_SHA="$(git rev-parse HEAD | cut -c1-8)" --build-arg GIT_BRANCH="$(git branch --show-current)" \
            -t "${{ steps.katana-app.outputs.app }}-image:${{ github.sha }}" .
          # and then build/tag a test image using the cache from ^^^
          docker build --platform linux/arm64 --target builder --force-rm --secret id=npm_token,env=ARTIFACTORY_RO_TOKEN \
            -t "${{ steps.katana-app.outputs.app }}-tester:${{ github.sha }}" .
  
      - name: Set up build vars for metadata
        run: |
          echo "BUILT_SHORT_SHA=$(git rev-parse HEAD | cut -c1-8)" | tee -a $GITHUB_ENV
          echo "BUILT_BRANCH=$(git branch --show-current)" | tee -a $GITHUB_ENV
          echo "BUILT_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" | tee -a $GITHUB_ENV

      # Publish the built container image to Katana with the katana-publish-artifact GitHub Action
      - id: katana-publish
        name: Publish Katana Artifact
        uses: gdcorp-actions/katana-publish-artifact@v1
        with:
          jwt: ${{ steps.katana-auth.outputs.jwt }}
          namespace: ${{ steps.katana-app.outputs.namespace }}
          app: ${{ steps.katana-app.outputs.app }}
          image_name: ${{ steps.katana-app.outputs.app }}-image:${{ github.sha }}
          artifact_kind: ecs
          artifact_options_json: |
            {
              "ports": [8443],
              "protocol": "https",
              "healthcheckPath": "/healthcheck",
              "environmentVariables": [
                { "name": "BUILT_SHORT_SHA", "value": "${{ env.BUILT_SHORT_SHA }}" },
                { "name": "BUILT_BRANCH", "value": "${{ env.BUILT_BRANCH }}" },
                { "name": "BUILT_AT", "value": "${{ env.BUILT_AT }}" }
              ]
            }

      # Promote the published artifact to the `dev-private` environment with the katana-promote-artifact GitHub Action
      - name: Promote to Dev Private Environment
        uses: gdcorp-actions/katana-promote-artifact@v1
        with:
          jwt: ${{ steps.katana-auth.outputs.jwt }}
          namespace: ${{ steps.katana-app.outputs.namespace }}
          app: ${{ steps.katana-app.outputs.app }}
          environment: ${{ github.event.inputs.environment }}
          artifact_id: ${{ steps.katana-publish.outputs.artifact_id }}